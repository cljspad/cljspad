{"version":3,"sources":["shadow/cljs/bootstrap/browser.cljs"],"mappings":"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","names":["js/shadow","js/shadow.cljs","js/shadow.cljs.bootstrap","js/shadow.cljs.bootstrap.browser","js/shadow.cljs.bootstrap.browser.init-opts","shadow.cljs.bootstrap.browser/init-opts","cljs.core.atom","var_args","args__4742__auto__","len__4736__auto__","i__4737__auto__","argseq__4743__auto__","cljs.core/IndexedSeq","shadow.cljs.bootstrap.browser/asset-path","seq31935","self__4724__auto__","cljs.core/seq","args","cljs.core.apply","cljs.core/str","cljs.core/deref","shadow.cljs.bootstrap.browser/compile-state-ref?","x","cljs.core/Atom","cljs.core/map?","shadow.cljs.bootstrap.browser/transit-read","txt","r","cognitect.transit.reader","cognitect.transit/read","shadow.cljs.bootstrap.browser/transit-load","path","callback","goog.net.XhrIo/send","res","req","cljs.core/not","cljs.core.ex_info","data","shadow.cljs.bootstrap.browser/script-eval","code","js/goog.globalEval","p__31978","map__31979","cljs.core/PROTOCOL_SENTINEL","cljs.core/hash-map","cljs.core.get","shadow.cljs.bootstrap.browser/execute-load!","compile-state-ref","type","text","uri","ns","provides","load-info","temp__5735__auto__","load-fn","G__31981","cljs.core/Keyword","js/Error","cljs.js/load-analysis-cache!","cljs.core.swap_BANG_","shadow.cljs.bootstrap.env/loaded-ref","clojure.set/union","cljs.js/*loaded*","js","shadow.cljs.bootstrap.browser/queue-task!","task","js/goog.async.run","shadow.cljs.bootstrap.browser/load-namespaces","namespaces","cb","cljs.core/set?","cljs.core/every?","cljs.core/symbol?","cljs.core/fn?","deps-to-load-for-ns","shadow.cljs.bootstrap.env/find-deps","macro-deps","p1__31982#","cljs.core.filter","cljs.core._EQ_","cljs.core.map","cljs.core.reduce","p1__31983#","cljs.core.symbol","cljs.core.into","deps-to-load-with-macros","clojure.set.union","compile-state","things-already-loaded","p1__31984#","clojure.set/superset?","js-files-to-load","p1__31985#","cljs.core.remove","p__32002","map__32007","js-name","shadow.cljs.bootstrap.browser.asset_path","analyzer-data-to-load","p1__31986#","p1__31987#","cljs.core.get_in","p__32014","map__32015","ana-name","cljs.core/empty?","G__32034","uris","loader","js/goog.net.BulkLoader","cljs.core.into_array","js/goog.net.EventType.SUCCESS","e","texts","seq__32050","chunk__32051","count__32052","i__32053","cljs.core/chunked-seq?","c__4556__auto__","cljs.core/chunk-first","cljs.core/chunk-rest","cljs.core/count","cljs.core/first","cljs.core/next","load","p1__31988#","p2__31989#","cljs.core.assoc","G__32068","p__32069","map__32070","shadow.cljs.bootstrap.browser/load","name","macros","rc","cljs.core/Symbol","or__4126__auto__","shadow.cljs.bootstrap.env/get-ns-info","shadow.cljs.bootstrap.browser/fix-provide-conflict!","js/cljs","p__32074","map__32075","shadow.cljs.bootstrap.browser/init","load-on-init","opts","init-cb","cljs.core/reset!","shadow.cljs.bootstrap.env/index-ref","shadow.cljs.bootstrap.env/create-cljs-user!","map__32077","exclude","idx","shadow.cljs.bootstrap.env/build-index","p1__32073#"],"sourcesContent":["(ns shadow.cljs.bootstrap.browser\n  (:require [clojure.set :as set]\n            [cljs.js :as cljs]\n            [cognitect.transit :as transit]\n            [shadow.js] ;; ensures that bootstrap namespaces can use js deps\n            [shadow.cljs.bootstrap.env :as env]\n            [goog.async.run]\n            [goog.net.XhrIo :as xhr])\n  (:import [goog.net BulkLoader]))\n\n\n(defonce init-opts (atom {:path \"/bootstrap\"\n                          :load-on-init []}))\n\n(defn asset-path [& args]\n  (apply str (:path @init-opts) args))\n\n(defn compile-state-ref? [x]\n  (and (instance? cljs.core/Atom x) (map? @x)))\n\n(defn transit-read [txt]\n  (let [r (transit/reader :json)]\n    (transit/read r txt)))\n\n(defn transit-load [path callback]\n  (xhr/send\n    path\n    (fn [res]\n      (this-as req\n        (if-not (.isSuccess req)\n          (throw (ex-info (str \"failed to download boostrap file:\" path \" status:\" (.getStatus req)) {:path path}))\n          (let [data (-> (.getResponseText req)\n                         (transit-read))]\n            (callback data)\n            ))))))\n\n(defn script-eval [code]\n  (js/goog.globalEval code))\n\n(defn execute-load! [compile-state-ref {:keys [type text uri ns provides] :as load-info}]\n  #_ (js/console.log \"load\" type ns load-info)\n  ;; quick hack for worker experiment, needs proper design\n  (when-let [load-fn (:load @init-opts)]\n    (load-fn load-info))\n  (case type\n    :analyzer\n    (let [data (transit-read text)]\n      (cljs/load-analysis-cache! compile-state-ref ns data))\n    :js\n    (do (swap! env/loaded-ref set/union provides)\n        (swap! cljs/*loaded* set/union provides)\n        (let [js (str text \"\\n//# sourceURL=\" uri \"\\n\")]\n          (script-eval js)))))\n\n(defn queue-task! [task]\n  ;; FIXME: this is a very naive queue that does all pending tasks at once\n  ;; should use something like window.requestIdleCallback that does as much work as\n  ;; possible in the time it was given and then yield control back to the browser\n  (js/goog.async.run task))\n\n(defn load-namespaces\n  \"loads a set of namespaces, must be called after init\"\n  [compile-state-ref namespaces cb]\n  {:pre [(compile-state-ref? compile-state-ref)\n         (set? namespaces)\n         (every? symbol? namespaces)\n         (fn? cb)]}\n  (let [deps-to-load-for-ns\n        (env/find-deps namespaces)\n\n        macro-deps\n        (->> deps-to-load-for-ns\n             (filter #(= :cljs (:type %)))\n             (map :macro-requires)\n             (reduce set/union)\n             (map #(symbol (str % \"$macros\")))\n             (into #{}))\n\n        ;; second pass due to circular dependencies in macros\n        deps-to-load-with-macros\n        (env/find-deps (set/union namespaces macro-deps))\n\n        compile-state\n        @compile-state-ref\n\n        things-already-loaded\n        (->> deps-to-load-with-macros\n             (filter #(set/superset? @env/loaded-ref (:provides %)))\n             (map :provides)\n             (reduce set/union))\n\n        js-files-to-load\n        (->> deps-to-load-with-macros\n             (remove #(set/superset? @env/loaded-ref (:provides %)))\n             (map (fn [{:keys [ns provides js-name]}]\n                    {:type :js\n                     :ns ns\n                     :provides provides\n                     :uri (asset-path js-name)})))\n\n        analyzer-data-to-load\n        (->> deps-to-load-with-macros\n             (filter #(= :cljs (:type %)))\n             ;; :dump-core still populates the cljs.core analyzer data with an empty map\n             (filter #(nil? (get-in compile-state [:cljs.analyzer/namespaces (:ns %) :name])))\n             (map (fn [{:keys [ns ana-name]}]\n                    {:type :analyzer\n                     :ns ns\n                     :uri (asset-path ana-name)})))\n\n        load-info\n        (-> []\n            (into js-files-to-load)\n            (into analyzer-data-to-load))]\n\n    #_ (js/console.log \"going to load\" load-info)\n\n    ;; this is transfered to cljs/*loaded* here to delay it as much as possible\n    ;; the JS may already be loaded but the analyzer data may be missing\n    ;; this way cljs.js is forced to ask first\n    (swap! cljs/*loaded* set/union things-already-loaded)\n\n    ;; may not need to load anything sometimes?\n    (if (empty? load-info)\n      (cb {:lang :js :source \"\"})\n\n      (let [uris\n            (into [] (map :uri) load-info)\n\n            loader\n            (BulkLoader. (into-array uris))]\n\n        (.listen loader js/goog.net.EventType.SUCCESS\n          (fn [e]\n            (let [texts (.getResponseTexts loader)]\n              (doseq [load (map #(assoc %1 :text %2) load-info texts)]\n                (queue-task! #(execute-load! compile-state-ref load)))\n\n              #_ (queue-task! #(js/console.log \"compile-state after load\" @compile-state-ref))\n\n              ;; callback with dummy so cljs.js doesn't attempt to load deps all over again\n              (queue-task! #(cb {:lang :js :source \"\"}))\n              )))\n\n        (.load loader)))\n    ))\n\n(defn load\n  \":load fn for cljs.js, must be passed the compile-state as first arg\n   eg. :load (partial boot/load compile-state-ref)\"\n  [compile-state-ref {:keys [name path macros] :as rc} cb]\n  {:pre [(compile-state-ref? compile-state-ref)\n         (symbol? name)\n         (fn? cb)]}\n  (let [ns (if macros\n             (symbol (str name \"$macros\"))\n             name)]\n    (or (get-in @compile-state-ref [:cljs.analyzer/namespaces ns])\n        (env/get-ns-info ns))\n    (load-namespaces compile-state-ref #{ns} cb)))\n\n(defn fix-provide-conflict! []\n  ;; since cljs.js unconditionally does a goog.require(\"cljs.core$macros\")\n  ;; the compile pretended to provide this but didn't\n  ;; need to remove that before we load it, otherwise it would goog.provide conflict\n  ;; FIXME: should test if actually empty, might delete something accidentally?\n  (js-delete js/cljs \"core$macros\"))\n\n(defn init\n  \"initializes the bootstrapped compiler by loading the dependency index\n   and loading cljs.core + macros (and namespaces specified in :load-on-init)\"\n  [compile-state-ref {:keys [load-on-init] :as opts} init-cb]\n  {:pre [(compile-state-ref? compile-state-ref)\n         (map? opts)\n         (fn? init-cb)\n         (string? (:path opts))]}\n  ;; FIXME: add goog-define to path\n\n  (reset! init-opts opts)\n\n  (if @env/index-ref\n    (init-cb)\n    (do (fix-provide-conflict!)\n        (env/create-cljs-user!)\n        (transit-load (asset-path \"/index.transit.json\")\n          (fn [data]\n            ;; pretend that all excluded macro namespaces are loaded\n            ;; so CLJS doesn't request them\n            ;; the macro are never available so any code trying to use them will fail\n            (let [{:keys [exclude] :as idx} (env/build-index data)]\n              (swap! cljs/*loaded* set/union (into #{} (map #(symbol (str % \"$macros\"))) exclude)))\n\n            (load-namespaces\n              compile-state-ref\n              (into '#{cljs.core cljs.core$macros} load-on-init)\n              init-cb))))))\n"]}